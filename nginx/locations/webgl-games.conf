# WebGL Games Configuration (Construct 3 & Unity)
# This configuration handles WebGL games with proper headers and MIME types for all projects

# Location block for WebGL games - matches any directory
location ~ ^/[^/]+/ {
    # Set root directory
    root /var/www;
    
    # Enable compression for WebGL assets (Construct 3 & Unity)
    gzip on;
    gzip_vary on;
    gzip_types
        application/javascript
        application/json
        application/wasm
        application/octet-stream
        text/css
        text/javascript
        text/plain
        image/svg+xml;
    
    # CORS headers for WebGL compatibility (required for both Construct 3 & Unity)
    add_header Cross-Origin-Embedder-Policy "credentialless" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type "text/plain; charset=utf-8";
        add_header Content-Length 0;
        return 204;
    }
    
    # Security headers optimized for WebGL
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Service Worker headers
    location ~ /sw\.js$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        add_header Service-Worker-Allowed "/";
    }
    
    # WebAssembly MIME type (Construct 3 & Unity)
    location ~ \.(wasm)$ {
        add_header Content-Type application/wasm;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Unity WebGL specific files
    location ~ \.(data|symbols\.json)$ {
        add_header Content-Type application/octet-stream;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Unity Brotli compressed JavaScript files (framework.js.br)
    location ~ \.(framework\.js\.br)$ {
        add_header Content-Type application/javascript;
        add_header Content-Encoding br;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Unity Brotli compressed data files (data.br, wasm.br)
    location ~ \.(data\.br|wasm\.br)$ {
        add_header Content-Type application/octet-stream;
        add_header Content-Encoding br;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Unity Gzip compressed files (legacy)
    location ~ \.(unityweb|gz)$ {
        add_header Content-Type application/octet-stream;
        add_header Content-Encoding gzip;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Unity uncompressed framework and loader files
    location ~ \.(framework\.js|loader\.js)$ {
        add_header Content-Type application/javascript;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # JavaScript modules and files
    location ~ \.(js|mjs)$ {
        add_header Content-Type application/javascript;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # JSON files (data, manifest, offline)
    location ~ \.(json)$ {
        add_header Content-Type application/json;
        # Shorter cache for game data files
        expires 1h;
        add_header Cache-Control "public";
    }
    
    # Web App Manifest
    location ~ /appmanifest\.json$ {
        add_header Content-Type application/manifest+json;
        expires 1d;
        add_header Cache-Control "public";
    }
    
    # Audio files (Construct 3 & Unity)
    location ~ \.(webm|ogg|mp3|wav|m4a|aac)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Set appropriate MIME types
        location ~ \.webm$ { add_header Content-Type audio/webm; }
        location ~ \.ogg$ { add_header Content-Type audio/ogg; }
        location ~ \.mp3$ { add_header Content-Type audio/mpeg; }
        location ~ \.wav$ { add_header Content-Type audio/wav; }
        location ~ \.m4a$ { add_header Content-Type audio/mp4; }
        location ~ \.aac$ { add_header Content-Type audio/aac; }
    }
    
    # Image files
    location ~ \.(webp|png|jpg|jpeg|gif|svg)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Font files
    location ~ \.(ttf|woff|woff2|eot|otf)$ {
        add_header Access-Control-Allow-Origin "*";
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # CSS files
    location ~ \.css$ {
        add_header Content-Type text/css;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # HTML files (no cache for main index.html)
    location ~ \.html$ {
        add_header Content-Type text/html;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }
    
    # Default file serving with fallbacks for both Construct 3 and Unity
    try_files $uri $uri/ @webgl_fallback;
    
    # Error handling for WebGL games
    error_page 404 @webgl_fallback;
}

# Fallback location for WebGL games
location @webgl_fallback {
    # Try to serve index.html for the project directory
    try_files /$1/index.html /index.html =404;
}

# Location block for detecting and handling WebGL build files
location ~ \.(unityweb|data|data\.br|wasm\.br|framework\.js\.br|symbols\.json|framework\.js|loader\.js)$ {
    root /var/www;
    
    # Unity specific headers
    add_header Cross-Origin-Embedder-Policy "credentialless" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Access-Control-Allow-Origin "*" always;
    
    # Handle Unity Brotli compressed JavaScript files
    if ($uri ~ \.(framework\.js\.br)$) {
        add_header Content-Encoding br;
        add_header Content-Type application/javascript;
    }
    
    # Handle Unity Brotli compressed data/wasm files
    if ($uri ~ \.(data\.br|wasm\.br)$) {
        add_header Content-Encoding br;
        add_header Content-Type application/octet-stream;
    }
    
    # Handle Unity Gzip compressed files (legacy)
    if ($uri ~ \.(unityweb|gz)$) {
        add_header Content-Encoding gzip;
        add_header Content-Type application/octet-stream;
    }
    
    # Handle Unity uncompressed data files
    if ($uri ~ \.(data|symbols\.json)$) {
        add_header Content-Type application/octet-stream;
    }
    
    # Handle Unity uncompressed JavaScript files
    if ($uri ~ \.(framework\.js|loader\.js)$) {
        add_header Content-Type application/javascript;
    }
    
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Additional location for WebGL game detection and auto-configuration
location ~ ^/([^/]+)/(index\.html|Build/|StreamingAssets/|TemplateData/)? {
    root /var/www;
    
    # Apply WebGL headers for any detected game project
    add_header Cross-Origin-Embedder-Policy "credentialless" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Access-Control-Allow-Origin "*" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    
    # Try to serve the requested file, directory, or fallback to index.html
    try_files $uri $uri/ /$1/index.html =404;
}
